apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "fullname" . }}-hooks-{{ randAlphaNum 5 | lower }}
  labels:
    heritage: {{.Release.Service | quote }}
    release: {{.Release.Name | quote }}
    chart: "{{.Chart.Name}}-{{.Chart.Version}}"
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade,pre-rollback
spec:
  activeDeadlineSeconds: 100
  template:
    metadata:
      name: {{ template "fullname" . }}-hooks-{{ randAlphaNum 5 | lower }}
      labels:
        heritage: {{.Release.Service | quote }}
        release: {{.Release.Name | quote }}
        chart: "{{.Chart.Name}}-{{.Chart.Version}}"
    spec:
      restartPolicy: Never
      containers:
      - name: database-migrate
        image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
        command:
        - 'python'
        - 'manage.py'
        - 'migrate'
        env:
        - name: DEBUG
          value: 'false'
        - name: ALLOWED_HOSTS
          value: "{{ .Values.backend.config.allowed_hosts }}"
        - name: SECRET_KEY
          value: {{ .Values.backend.config.secret_key }}
        - name: DATABASE_URL
          value: {{ .Values.backend.config.database_url }}
        - name: CACHE_URL
          value: {{ .Values.backend.config.cache_url }}
        - name: EMAIL_URL
          value: {{ .Values.backend.config.email_url }}
        - name: SENTRY
          value: {{ .Values.backend.config.sentry }}
        - name: CELERY_BROKER_URL
          value: {{ .Values.backend.config.celery_broker_url }}
        - name: CHANNELS_REDIS_URL
          value: {{ .Values.backend.config.channels_redis_url }}
        - name: REDIS_STREAM_HOST
          value: {{ .Values.backend.config.stream_redis_host }}
        - name: REDIS_STREAM_DB
          value: "{{ .Values.backend.config.stream_redis_db }}"
        - name: ELASTICSEARCH_HOST
          value: {{ .Values.backend.config.elasticsearch_host }}
        - name: AWS_ACCESS_KEY_ID
          value: {{ .Values.backend.config.aws_access_key_id }}
        - name: AWS_SECRET_ACCESS_KEY
          value: {{ .Values.backend.config.aws_secret_access_key }}
        - name: AWS_REGION
          value: {{ .Values.backend.config.aws_region }}
        - name: AWS_S3_BUCKET
          value: {{ .Values.backend.config.aws_s3_bucket }}
        - name: THUMBOR_SERVER
          value: {{ .Values.backend.config.thumbor_server }}
        - name: THUMBOR_SECURITY_KEY
          value: {{ .Values.backend.config.thumbor_security_key }}
        - name: SERVER_URL
          value: {{ .Values.backend.config.server_url }}
        - name: FRONTEND_URL
          value: {{ .Values.backend.config.frontend_url }}
        - name: CASSANDRA_HOSTS
          value: {{ .Values.backend.config.cassandra_hosts }}
        - name: CASSANDRA_KEYSPACE
          value: {{ .Values.backend.config.cassandra_keyspace }}
        - name: STRIPE_API_KEY
          value: {{ .Values.backend.config.stripe_api_key }}
        - name: CAPTCHA_KEY
          value: {{ .Values.backend.config.captcha_key }}
      imagePullSecrets:
      - name: registry.abakus.no
